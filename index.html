<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡‘åˆ©é¤˜çš„ç«éœ‡ç”Ÿå­˜è©¦ç…‰ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050510;
            --neon-green: #39ff14;
            --neon-pink: #ff00ff;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffff00;
            --neon-red: #ff3333;
            --win-gray: #c0c0c0;
            --win-blue: #000080;
        }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-dark);
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-family: 'DotGothic16', monospace;
            color: white;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        img, canvas, div {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 6px 100%;
            pointer-events: none; z-index: 9000;
        }

        .flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 9100;
        }

        /* === å•Ÿå‹•ç•«é¢ === */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .title-glitch {
            font-size: 4rem; color: var(--neon-green);
            text-shadow: 4px 4px var(--neon-pink);
            animation: glitch 1s infinite;
            margin-bottom: 30px;
        }
        
        @media (max-width: 600px) {
            .title-glitch { font-size: 2.5rem; }
            .start-btn { font-size: 1.5rem !important; padding: 15px 30px !important; }
        }

        .start-btn {
            margin-top: 20px; padding: 20px 50px;
            font-size: 2rem; background: transparent; color: #fff;
            border: 4px solid var(--neon-cyan); cursor: pointer;
            font-family: inherit; animation: pulse 1.5s infinite;
            text-transform: uppercase;
        }

        /* === éŠæˆ²ä¸»å®¹å™¨ === */
        #game-wrapper {
            position: relative;
            width: 800px; height: 600px;
            transform-origin: center;
            z-index: 10;
            transition: transform 0.1s;
        }
        .shake-anim { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        #game-container {
            width: 100%; height: 100%;
            background: #222;
            position: relative;
            overflow: hidden;
            border: 4px solid var(--neon-cyan);
            box-shadow: 0 0 30px var(--neon-cyan);
        }

        /* === èƒŒæ™¯å±¤ === */
        #scene-layer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            transition: filter 0.3s; z-index: 0;
            background-size: cover; background-position: center;
        }
        .bg-intro { background: #000; }
        .bg-street { background: #2c3e50; background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, #444 20px); }
        .bg-house { background: #5d4037; }
        .bg-kitchen { background: #37474f; }
        .bg-bank { background: #0d47a1; }
        .bg-room { background: #4e342e; }
        .bg-ruins { background: #212121; filter: grayscale(1) contrast(1.5) sepia(0.3) !important; }
        
        /* === è§’è‰²å±¤ === */
        #char-layer {
            position: absolute; bottom: 290px; width: 100%; height: 280px;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: space-between; padding: 0 60px;
        }
        .char-img {
            height: 100%; width: auto;
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,1));
            transition: transform 0.2s, filter 0.2s, opacity 0.2s;
            opacity: 0;
        }
        .char-visible { opacity: 1; }
        #char-kin { transform: scale(1); } 
        #char-chill { transform: scale(1.15); }
        .speaking { filter: brightness(1.2) drop-shadow(0 0 10px var(--neon-green)); transform: translateY(-10px) scale(1.05) !important; opacity: 1; z-index: 12; }
        .not-speaking { filter: brightness(0.4) grayscale(0.5); opacity: 0.8; z-index: 10; }

        /* === UI å±¤ === */
        #ui-layer { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; pointer-events: none; }

        #hud-box {
            position: absolute; top: 20px; left: 20px;
            background: #000; border: 2px solid #fff;
            padding: 10px 20px; 
            font-size: 1.5rem;
            display: flex; gap: 30px; pointer-events: none;
            box-shadow: 5px 5px 0 #555;
        }

        #dialogue-area {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            height: 260px; 
            background: #000080;
            border: 4px solid #fff;
            padding: 25px; pointer-events: auto;
            display: flex; flex-direction: column;
            box-shadow: 10px 10px 0 #000; cursor: pointer;
        }
        #name-tag {
            background: var(--neon-pink); color: #000;
            padding: 5px 15px; font-weight: bold; font-size: 1.4rem;
            align-self: flex-start; margin-bottom: 15px;
            border: 2px solid #fff; box-shadow: 4px 4px 0 #000;
            transform: rotate(-2deg);
        }
        #dialogue-text {
            font-size: 1.6rem; line-height: 1.6; flex: 1;
            overflow-y: auto; text-shadow: 2px 2px 0 #000;
            white-space: pre-line; color: #fff; padding-right: 10px;
            scroll-behavior: smooth;
        }

        #next-arrow { 
            position: absolute; bottom: 15px; right: 20px;
            font-size: 2rem; color: var(--neon-green); 
            animation: blink 0.8s steps(2, start) infinite; 
            display: none; 
        }

        /* === é¸é …é¸å–® === */
        #options-box {
            position: absolute; right: 40px; bottom: 300px;
            display: flex; flex-direction: column; gap: 15px;
            pointer-events: auto; align-items: flex-end; z-index: 30;
        }
        .option-btn {
            background: #000; border: 3px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 15px 25px;
            font-family: inherit; font-size: 1.4rem; cursor: pointer;
            min-width: 500px; text-align: left; transition: 0.1s;
            box-shadow: 6px 6px 0 rgba(0,255,255,0.3);
            position: relative;
        }
        .option-btn:hover, .option-btn.selected { 
            background: var(--neon-cyan); color: #000; 
            box-shadow: 0 0 15px var(--neon-cyan); 
            transform: translateX(-15px);
        }
        .option-btn.selected::before {
            content: 'â–º'; position: absolute; left: -30px; color: var(--neon-pink);
            animation: blink 0.5s infinite;
        }

        .floating-text {
            position: absolute;
            font-weight: bold; font-size: 2rem;
            animation: floatUp 1.5s ease-out forwards;
            text-shadow: 2px 2px 0 #000;
            z-index: 100; pointer-events: none;
        }

        /* === é€šç”¨ï¼šéµç›¤é¸ä¸­æ•ˆæœ === */
        .selected-target {
            outline: 5px solid var(--neon-yellow);
            box-shadow: 0 0 20px var(--neon-yellow);
            z-index: 100;
        }

        /* === é¢¨éšªå››è±¡é™åœ– === */
        #risk-matrix-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 60;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        .matrix-container {
            display: grid; grid-template-columns: 40px 1fr 1fr; grid-template-rows: 40px 1fr 1fr;
            gap: 5px; width: 600px; height: 450px; background: transparent;
        }
        .matrix-label { display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #aaa; text-align: center; }
        .matrix-cell {
            border: 2px solid #fff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 10px;
            font-size: 1.5rem; text-align: center; transition: all 0.3s; background: #111;
        }
        .matrix-cell h3 { margin: 0 0 10px 0; color: var(--neon-cyan); }
        .matrix-cell p { font-size: 1rem; color: #ccc; margin: 0; }
        .matrix-cell.highlight-transfer { border-color: var(--neon-pink); box-shadow: inset 0 0 20px var(--neon-pink); background: #220022; }

        /* === ç¿»ç‰Œè¨˜æ†¶éŠæˆ² === */
        #memory-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 65;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        .memory-grid {
            display: grid; grid-template-columns: repeat(4, 120px); gap: 15px;
            margin-top: 20px;
        }
        .memory-card {
            width: 120px; height: 160px;
            background: #000080; border: 4px solid #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 3rem; cursor: pointer; color: transparent;
            position: relative; transition: transform 0.2s;
        }
        .memory-card::before { content: '?'; color: var(--neon-yellow); font-size: 3rem; position: absolute; }
        .memory-card.flipped { background: #fff; color: #000; transform: rotateY(180deg); }
        /* === ç¿»ç‰Œæ–‡å­—ä¿®æ­£ === */
        .memory-card.flipped .memory-text { transform: rotateY(180deg); }
        .memory-card.flipped::before { display: none; }
        .memory-card.matched { background: var(--neon-green); border-color: var(--neon-green); opacity: 0.5; pointer-events: none; }
        .memory-card:hover, .memory-card.selected-target { transform: scale(1.05); border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); z-index: 5; }
        .memory-text { font-size: 1.2rem; text-align: center; line-height: 1.2; padding: 5px; color: #000;}

        /* === å¯¦ä½œåœ°åœ–ä»‹é¢ === */
        #map-interface {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 500px; background: #c0c0c0;
            border: 4px solid #000; z-index: 50; display: none;
            flex-direction: column; padding: 5px; color: #000; pointer-events: auto;
            box-shadow: 20px 20px 0 rgba(0,0,0,0.8);
        }
        .map-header { background: #000080; color: white; padding: 8px; margin-bottom: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .map-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; flex: 1; padding: 10px; background: #444; }
        .map-tile {
            background: #aaa; border: 4px solid #888;
            display: flex; justify-content: center; align-items: center;
            font-size: 4rem; cursor: pointer; position: relative;
            image-rendering: pixelated; transition: transform 0.1s;
        }
        .map-tile:hover, .map-tile.selected { 
            border-color: var(--neon-yellow); 
            background: #eee; 
            transform: scale(1.05); 
            z-index: 2; 
            box-shadow: 0 0 15px var(--neon-yellow);
        }

        /* === æ©Ÿæœƒèˆ‡å‘½é‹å°éŠæˆ² === */
        #chance-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,50,0.95); z-index: 70;
            display: none; flex-direction: column; pointer-events: auto;
            justify-content: center; align-items: center;
        }
        .card-container { display: flex; gap: 50px; margin-top: 30px; }
        .game-card {
            width: 200px; height: 300px;
            background: linear-gradient(135deg, #000080, #000);
            border: 5px solid #fff; border-radius: 15px;
            display: flex; justify-content: center; align-items: center;
            font-size: 5rem; cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }
        .game-card::after { content: '?'; color: var(--neon-yellow); text-shadow: 3px 3px 0 #000; }
        .game-card:hover, .game-card.selected {
            transform: translateY(-20px) scale(1.1);
            box-shadow: 0 0 30px var(--neon-cyan);
            border-color: var(--neon-cyan);
        }
        .game-card.flipped { background: #fff; color: #000; font-size: 1.5rem; padding: 10px; text-align: center; }
        .game-card.flipped::after { content: ''; }

        /* === å­¸ç¿’åœ–å¡ === */
        #learning-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
            pointer-events: auto; backdrop-filter: grayscale(1) blur(4px);
        }
        .retro-window {
            width: 700px; background: var(--win-gray);
            border: 3px solid #fff;
            border-right-color: #404040; border-bottom-color: #404040;
            box-shadow: 20px 20px 0 #000; display: flex; flex-direction: column;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .win-header { background: var(--win-blue); color: #fff; padding: 8px 12px; font-weight: bold; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .win-body { padding: 25px; color: #000; font-size: 1.4rem; line-height: 1.6; max-height: 450px; overflow-y: auto; }
        .learning-title { font-size: 1.8rem; color: #000; border-bottom: 4px double #808080; margin-bottom: 20px; padding-bottom: 10px; font-weight: 900; }
        .win-btn { align-self: center; margin-top: 25px; padding: 10px 30px; font-family: inherit; font-size: 1.2rem; background: var(--win-gray); cursor: pointer; border: 2px solid #fff; border-right-color: #404040; border-bottom-color: #404040; box-shadow: 2px 2px 0 #000; }
        .win-btn:focus, .win-btn:hover { background: #eee; outline: 2px solid #000; }

        /* === å»šæˆ¿å±æ©Ÿæ‰¾ç¢´éŠæˆ² (å¯è¦–åŒ–åœ–ç¤º) === */
        #hazard-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 55; display: none; pointer-events: auto;
            background: rgba(0,0,0,0.3);
        }
        .hazard-target {
            position: absolute; 
            width: 80px; height: 80px;
            font-size: 4rem;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; 
            animation: pulse 0.8s infinite alternate;
            filter: drop-shadow(0 0 10px red);
            transition: transform 0.1s;
        }
        .hazard-target:hover { transform: scale(1.2); filter: drop-shadow(0 0 20px yellow); }

        /* === æ»…ç«å™¨ç¯€å¥éŠæˆ² === */
        #extinguisher-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 56;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        .gauge-container {
            width: 600px; height: 60px; background: #333; border: 4px solid #fff;
            position: relative; border-radius: 30px; overflow: hidden; margin: 20px;
        }
        .gauge-target {
            width: 100px; height: 100%; background: lime; position: absolute; left: 50%; transform: translateX(-50%);
        }
        .gauge-cursor {
            width: 10px; height: 100%; background: red; position: absolute; left: 0;
            border: 2px solid white;
        }
        
        /* === ç‰†å£ä¿®è£œéŠæˆ² === */
        #crack-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;utf8,<svg width="40" height="40" xmlns="http://www.w3.org/2000/svg"><rect width="40" height="40" fill="%23444"/><path d="M0 0 L40 40 M40 0 L0 40" stroke="%23555"/></svg>');
            z-index: 57; display: none; pointer-events: auto;
        }
        .wall-crack {
            position: absolute; width: 80px; height: 80px;
            font-size: 4rem; cursor: pointer; color: #ff0000;
            text-shadow: 2px 2px 0 #000; animation: shake 0.5s infinite;
        }

        /* === ç‰©è³‡æ¥æ¥æ¨‚éŠæˆ² === */
        #falling-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,50,0.8); z-index: 59;
            display: none; pointer-events: auto; overflow: hidden;
        }
        #catcher-box {
            position: absolute; bottom: 20px; left: 350px; width: 100px; height: 100px;
            background: url('image/kinliyu.png') no-repeat center/contain;
            filter: drop-shadow(0 0 10px white);
        }
        .falling-item {
            position: absolute; width: 50px; height: 50px; font-size: 2.5rem;
            display: flex; justify-content: center; align-items: center;
        }

        /* === é€ƒç”Ÿåæ‡‰éŠæˆ² === */
        #reflex-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50,0,0,0.9); z-index: 62;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        #reflex-arrow {
            font-size: 15rem; color: white; text-shadow: 0 0 20px red;
            font-weight: bold;
        }
        /* Touch controls for reflex game */
        #reflex-controls {
            display: grid; grid-template-columns: 80px 80px 80px; grid-template-rows: 80px 80px;
            gap: 10px; margin-top: 30px;
        }
        .reflex-btn {
            width: 80px; height: 80px; background: rgba(255,255,255,0.2);
            border: 2px solid #fff; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-size: 2rem;
            cursor: pointer; user-select: none;
        }
        .reflex-btn:active { background: rgba(255,255,255,0.5); }

        /* === ç†è³ å¯©æ ¸éŠæˆ² === */
        #stamper-game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 64;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        .doc-paper {
            width: 300px; height: 400px; background: white; color: black;
            padding: 20px; font-size: 1.2rem; display: flex; flex-direction: column;
            gap: 10px; margin-bottom: 20px; position: relative;
        }
        .stamp-btn {
            font-size: 2rem; padding: 10px 30px; margin: 10px; cursor: pointer;
            border: 4px solid white; color: white; background: black;
        }
        .stamp-btn.approve { border-color: lime; color: lime; }
        .stamp-btn.reject { border-color: red; color: red; }
        .stamp-btn:active, .stamp-btn:hover { background: #333; }

        /* === ä¿è²»å¯†ç¢¼é–ä»‹é¢ === */
        #keypad-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 68;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        .keypad-box {
            background: #333; padding: 20px; border: 4px solid #fff;
            display: grid; grid-template-columns: repeat(3, 80px); gap: 10px;
            box-shadow: 10px 10px 0 #000;
        }
        .keypad-display {
            grid-column: 1 / -1; background: #000; color: var(--neon-green);
            font-size: 2.5rem; text-align: right; padding: 10px;
            font-family: monospace; border: 2px solid #555; margin-bottom: 10px;
            height: 60px; letter-spacing: 5px;
        }
        .key-btn {
            background: #555; border: 2px solid #888; color: #fff;
            font-size: 2rem; cursor: pointer; padding: 15px 0;
            text-align: center;
        }
        .key-btn:active { background: #777; transform: translate(2px, 2px); }
        .key-enter { background: var(--neon-blue); color: var(--neon-cyan); }
        .key-clear { background: var(--neon-red); color: #ffaaaa; }

        /* === åœ°éœ‡å¹³è¡¡éŠæˆ² === */
        #balance-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50,0,0,0.6); z-index: 69;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        .balance-bar-container {
            width: 500px; height: 40px; background: #333;
            border: 4px solid #fff; position: relative; border-radius: 20px;
            overflow: hidden; margin-top: 50px;
        }
        .balance-safe-zone {
            width: 150px; height: 100%; background: var(--neon-green);
            position: absolute; left: 50%; transform: translateX(-50%); opacity: 0.5;
        }
        .balance-marker {
            width: 20px; height: 40px; background: #fff; border: 2px solid #000;
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            transition: left 0.1s linear;
        }
        .balance-hint { color: var(--neon-yellow); font-size: 1.5rem; animation: blink 0.5s infinite; text-shadow: 2px 2px #000; }

        /* === å»¢å¢ŸæŒ–æ˜éŠæˆ² === */
        #debris-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 58; display: none; pointer-events: auto;
            justify-content: center; align-items: center;
        }
        .debris-pile {
            width: 400px; height: 300px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23333" width="100" height="100"/><path d="M0 0l50 50m50-50L50 50m0 0l-50 50m100 0L50 50" stroke="%23555" stroke-width="2"/></svg>');
            position: relative; cursor: pointer; border: 5px solid #000;
            display: flex; justify-content: center; align-items: center;
        }
        .policy-paper {
            width: 200px; height: 250px; background: #fff; color: #000;
            position: absolute; display: flex; justify-content: center; align-items: center;
            text-align: center; font-weight: bold; border: 2px solid #000;
            transform: rotate(-5deg); pointer-events: none;
        }

        /* === å‰ç¥¥ç‰© (å·¦ä¸‹è§’) === */
        #mascot-container { 
            position: fixed; bottom: 10px; left: 10px; 
            width: 130px; height: 130px; 
            z-index: 8000; cursor: help; pointer-events: auto; 
            transition: transform 0.2s;
        }
        #mascot-img { 
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(2px 2px 0 #fff); 
            transition: all 0.2s;
        }
        #mascot-container:hover { animation: shakeHard 0.2s infinite; }
        #mascot-container:hover #mascot-img {
            filter: drop-shadow(0 0 10px #ff0000) drop-shadow(0 0 20px #00ff00) drop-shadow(0 0 30px #0000ff) brightness(1.3);
        }

        /* === Footer === */
        footer { 
            position: fixed; bottom: 5px; width: 100%; 
            text-align: center; color: #aaa; 
            font-size: 1rem; font-family: sans-serif; 
            z-index: 10001; text-shadow: 2px 2px 0 #000; pointer-events: none;
        }

        /* === æ…¶ç¥ç•«é¢ === */
        #congrats-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 150; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .congrats-text { font-size: 5rem; color: gold; animation: pulse 0.2s infinite; text-shadow: 5px 5px 0 #000; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-3px, 3px); } 40% { transform: translate(-3px, -3px); } 60% { transform: translate(3px, 3px); } 80% { transform: translate(3px, -3px); } 100% { transform: translate(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }
        @keyframes shakeHard { 0% { transform: translate(2px, 1px) rotate(0deg); } 25% { transform: translate(-2px, -2px) rotate(-5deg); } 50% { transform: translate(-3px, 0px) rotate(5deg); } 75% { transform: translate(3px, 2px) rotate(0deg); } 100% { transform: translate(1px, -1px) rotate(-5deg); } }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        @keyframes flashRed { 0% { background: red; opacity: 0.3; } 100% { background: white; opacity: 0; } }

        #controls-hint { position: absolute; top: 10px; right: 10px; color: var(--neon-cyan); font-size: 1rem; text-align: right; line-height: 1.5; text-shadow: 1px 1px 0 #000;}
    </style>
</head>
<body>

    <div class="crt-overlay"></div>
    <div class="flash-overlay" id="flash-fx"></div>

    <div id="start-screen">
        <div class="title-glitch">é‡‘åˆ©é¤˜ç”Ÿå­˜è©¦ç…‰</div>
        <p style="font-size: 1.5rem; margin-top: 20px; color: #aaa; font-family: sans-serif;">- RISK SURVIVAL -</p>
        <button class="start-btn" id="start-btn-element" onclick="startGame()">> START GAME <</button>
    </div>

    <div id="game-wrapper">
        <div id="game-container">
            <div id="scene-layer" class="bg-intro"></div>
            <div id="char-layer">
                <img id="char-kin" class="char-img" src="image/kinliyu.png" alt="é‡‘åˆ©é¤˜" onerror="this.style.display='none'"> 
                <img id="char-chill" class="char-img" src="image/chiuliyu.png" alt="ç§‹é¯‰é­š" onerror="this.style.display='none'">
            </div>
            
            <!-- å»šæˆ¿å±æ©Ÿæ‰¾ç¢´éŠæˆ² -->
            <div id="hazard-game-overlay">
                <div class="hazard-target" style="top: 100px; left: 150px;" onclick="foundHazard(this)">ğŸ”¥</div>
                <div class="hazard-target" style="top: 120px; left: 550px;" onclick="foundHazard(this)">âš¡</div>
                <div class="hazard-target" style="top: 220px; left: 350px;" onclick="foundHazard(this)">ğŸ”Œ</div>
                <div style="position:absolute; top:40px; width:100%; text-align:center; font-size:2.5rem; color:var(--neon-red); text-shadow:3px 3px 0 #000; pointer-events:none; font-weight:bold;">
                    !! æ‰¾å‡º 3 å€‹å±éšªæº !!
                </div>
                <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:#aaa;">(éµç›¤: æ–¹å‘éµé¸å–, Enterç¢ºèª)</div>
            </div>

            <!-- æ»…ç«å™¨ç¯€å¥éŠæˆ² -->
            <div id="extinguisher-game-overlay">
                <h1 style="color:var(--neon-green)">ğŸ”¥ æ»…ç«å™¨ç‰¹è¨“ ğŸ”¥</h1>
                <p>åœ¨æ¸¸æ¨™é€²å…¥ç¶ è‰²å€åŸŸæ™‚æŒ‰ä¸‹ç©ºç™½éµ/é»æ“Šï¼</p>
                <div class="gauge-container">
                    <div class="gauge-target"></div>
                    <div class="gauge-cursor" id="gauge-cursor"></div>
                </div>
                <div id="ext-msg" style="height:30px; color:yellow;"></div>
            </div>

            <!-- é¢¨éšªå››è±¡é™åœ– -->
            <div id="risk-matrix-overlay">
                <h1 style="color:var(--neon-yellow); text-shadow: 3px 3px 0 #000; margin-bottom: 20px;">âš ï¸ é¢¨éšªç®¡ç†åˆ†æç³»çµ± âš ï¸</h1>
                <div class="matrix-container">
                    <div class="matrix-label"></div>
                    <div class="matrix-label">æå¤±å¹…åº¦<br>(å°)</div>
                    <div class="matrix-label">æå¤±å¹…åº¦<br>(å¤§)</div>
                    <div class="matrix-label">ç™¼ç”Ÿæ©Ÿç‡<br>(é«˜)</div>
                    <div class="matrix-cell"><h3>ğŸ›¡ï¸ é¢¨éšªé™ä½</h3><p>æ”¹å–„ç¾æ³<br>æ¸›å°‘ç™¼ç”Ÿ</p></div>
                    <div class="matrix-cell" style="border-color:red; color:red;"><h3 style="color:red">â˜ ï¸ é¢¨éšªè¦é¿</h3><p>å¤ªå±éšªäº†<br>ç›´æ¥é€ƒè·‘</p></div>
                    <div class="matrix-label">ç™¼ç”Ÿæ©Ÿç‡<br>(ä½)</div>
                    <div class="matrix-cell"><h3>ğŸ’° é¢¨éšªè‡ªç•™</h3><p>å°éŒ¢è‡ªå·±å‡º<br>å½±éŸ¿ä¸å¤§</p></div>
                    <div class="matrix-cell highlight-transfer"><h3>âš–ï¸ é¢¨éšªç§»è½‰</h3><p>è²·ä¿éšª<br>æ‰¾äººæ‰›</p></div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="win-btn" onclick="closeRiskMatrix()">äº†è§£ï¼Œæ¡å–è¡Œå‹• (Enter)</button>
                </div>
            </div>

            <!-- ç¿»ç‰Œè¨˜æ†¶éŠæˆ² -->
            <div id="memory-game-overlay">
                <h1 style="color:var(--neon-green); text-shadow: 3px 3px 0 #000;">ğŸ§  é¢¨éšªè¨˜æ†¶ç‰¹è¨“ ğŸ§ </h1>
                <p style="color: #ccc;">æ‰¾å‡ºé…å°çš„é¢¨éšªç­–ç•¥ (ç¿»å…©å¼µ)</p>
                <div class="memory-grid" id="memory-grid"></div>
                <p style="color:#888; margin-top:10px;">(æ–¹å‘éµé¸æ“‡, Space/Enter ç¿»ç‰Œ)</p>
            </div>

            <!-- ç‰†å£ä¿®è£œéŠæˆ² -->
            <div id="crack-game-overlay">
                <div style="position:absolute; top:20px; width:100%; text-align:center; font-size:2rem; color:red; font-weight:bold;">
                    !! é»æ“Š/é¸å–ä¿®è£œ 5 å€‹è£‚ç¸« !!
                </div>
            </div>

            <!-- ç†è³ å¯©æ ¸éŠæˆ² -->
            <div id="stamper-game-overlay">
                <h2 style="color:white">ç†è³ æ–‡ä»¶å¯©æ ¸</h2>
                <div class="doc-paper" id="doc-paper">
                    <h3>ç†è³ ç”³è«‹æ›¸</h3>
                    <p>ç”³è«‹äºº: é‡‘åˆ©é¤˜</p>
                    <p>äº‹ç”±: åœ°éœ‡æˆ¿å±‹é¾œè£‚</p>
                    <div id="doc-seal" style="border:3px double red; color:red; padding:5px; transform:rotate(-15deg); display:none;">å·²æ ¸ç« </div>
                </div>
                <div>
                    <button class="stamp-btn approve" onclick="checkDoc(true)">â­• é€šé (â†)</button>
                    <button class="stamp-btn reject" onclick="checkDoc(false)">âŒ é€€ä»¶ (â†’)</button>
                </div>
                <p>è¦å‰‡ï¼šæœ‰ã€Œå·²æ ¸ç« ã€æ‰èƒ½é€šé</p>
            </div>

            <!-- ä¿è²»å¯†ç¢¼é– -->
            <div id="keypad-overlay">
                <h2 style="color:var(--neon-cyan); margin-bottom:10px;">è«‹è¼¸å…¥ã€Œä½å®…åœ°éœ‡åŸºæœ¬ä¿éšªã€å¹´ä¿è²»</h2>
                <div class="keypad-box">
                    <div class="keypad-display" id="keypad-display"></div>
                    <div class="key-btn" onclick="keypadInput(7)">7</div>
                    <div class="key-btn" onclick="keypadInput(8)">8</div>
                    <div class="key-btn" onclick="keypadInput(9)">9</div>
                    <div class="key-btn" onclick="keypadInput(4)">4</div>
                    <div class="key-btn" onclick="keypadInput(5)">5</div>
                    <div class="key-btn" onclick="keypadInput(6)">6</div>
                    <div class="key-btn" onclick="keypadInput(1)">1</div>
                    <div class="key-btn" onclick="keypadInput(2)">2</div>
                    <div class="key-btn" onclick="keypadInput(3)">3</div>
                    <div class="key-btn key-clear" onclick="keypadInput('C')">C</div>
                    <div class="key-btn" onclick="keypadInput(0)">0</div>
                    <div class="key-btn key-enter" onclick="keypadInput('E')">OK</div>
                </div>
                <p style="color:#888;">(å¯ä½¿ç”¨éµç›¤æ•¸å­—éµèˆ‡ Enter)</p>
            </div>

            <!-- ç‰©è³‡æ¥æ¥æ¨‚ -->
            <div id="falling-game-overlay">
                <div style="color:white; font-size:1.5rem; margin-top:20px; text-align:center;">
                    å·¦å³ç§»å‹•æ¥ä½æ°´(ğŸ’§)å’Œé£Ÿç‰©(ğŸ–)ï¼Œé¿é–‹çŸ³é ­(ğŸª¨)ï¼<br>
                    (æŒ‰ â† â†’ æˆ– æ‹–æ›³/é»æ“Š)
                </div>
                <div id="catcher-box"></div>
            </div>

            <!-- å¯¦ä½œåœ°åœ– UI -->
            <div id="map-interface">
                <div class="map-header">
                    <span>é˜²ç½åœ°åœ– App</span>
                    <span style="color:yellow">è«‹é¸æ“‡æ­£ç¢ºåœ°é»</span>
                </div>
                <div class="map-grid" id="map-grid"></div>
            </div>

            <!-- é€ƒç”Ÿåæ‡‰éŠæˆ² -->
            <div id="reflex-game-overlay">
                <h1 style="color:red; text-shadow:2px 2px 0 #000;">ä¾ç…§æŒ‡ç¤ºæ–¹å‘é€ƒç”Ÿï¼</h1>
                <div id="reflex-arrow">?</div>
                <div id="reflex-controls">
                    <div></div>
                    <div class="reflex-btn" onclick="checkReflexInput('ArrowUp')">â¬†ï¸</div>
                    <div></div>
                    <div class="reflex-btn" onclick="checkReflexInput('ArrowLeft')">â¬…ï¸</div>
                    <div class="reflex-btn" onclick="checkReflexInput('ArrowDown')">â¬‡ï¸</div>
                    <div class="reflex-btn" onclick="checkReflexInput('ArrowRight')">â¡ï¸</div>
                </div>
            </div>

            <!-- åœ°éœ‡å¹³è¡¡éŠæˆ² -->
            <div id="balance-overlay">
                <h1 class="balance-hint">ä¿æŒå¹³è¡¡ï¼(æŒ‰å·¦å³éµ / é»æ“Šå…©å´)</h1>
                <div class="balance-bar-container">
                    <div class="balance-safe-zone"></div>
                    <div class="balance-marker" id="balance-marker"></div>
                </div>
            </div>

            <!-- å»¢å¢ŸæŒ–æ˜éŠæˆ² -->
            <div id="debris-overlay">
                <div style="position:absolute; top:100px; color:white; font-size:2rem; text-shadow:2px 2px 0 black;">å¿«é€Ÿé»æ“Šæ¸…é™¤ç“¦ç¤«ï¼</div>
                <div class="debris-pile" onclick="hitDebris()">
                    <div class="policy-paper">
                        ä½å®…åœ°éœ‡<br>åŸºæœ¬ä¿éšªå–®<br><br>ä¿é¡ï¼š150è¬<br>è¢«ä¿äººï¼šé‡‘åˆ©é¤˜
                    </div>
                    <div id="debris-cover" style="position:absolute; top:0; left:0; width:100%; height:100%; background:#444; opacity:1;"></div>
                </div>
                <div style="color:#aaa; position:absolute; bottom:50px;">(é€£é»æ»‘é¼  æˆ– ç‹‚æŒ‰ç©ºç™½éµ/Enter)</div>
            </div>

            <!-- æ©Ÿæœƒå‘½é‹éŠæˆ² -->
            <div id="chance-game-overlay">
                <h1 style="color:var(--neon-cyan); font-size: 3rem; text-shadow: 4px 4px 0 #000;">ğŸƒ æ©Ÿæœƒï¼Ÿå‘½é‹ï¼Ÿ ğŸƒ</h1>
                <div class="card-container">
                    <div class="game-card" id="card-0" onclick="selectCard(0)"></div>
                    <div class="game-card" id="card-1" onclick="selectCard(1)"></div>
                </div>
            </div>

            <!-- çŸ¥è­˜åœ–å¡ -->
            <div id="learning-overlay">
                <div class="retro-window">
                    <div class="win-header">
                        <span>çŸ¥è­˜è£œçµ¦ç«™.EXE</span>
                        <span onclick="closeLearning()" style="cursor:pointer">[X]</span>
                    </div>
                    <div class="win-body">
                        <div class="learning-title" id="learn-title">æ¨™é¡Œ</div>
                        <div id="learn-content">å…§å®¹...</div>
                        <div style="text-align: center;">
                            <button class="win-btn" id="learning-btn" onclick="closeLearning()">æˆ‘å­¸æœƒäº† (Enter)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ…¶ç¥ç•«é¢ -->
            <div id="congrats-overlay">
                <div class="congrats-text">ğŸ‰ä»»å‹™é”æˆğŸ‰</div>
                <div style="font-size: 2rem; margin-top: 20px; color: #fff;">æ‚¨å·²æŒæ¡åœ°éœ‡ä¿éšªçŸ¥è­˜ï¼</div>
            </div>

            <!-- éŠæˆ² UI -->
            <div id="ui-layer">
                <div id="controls-hint">
                    [æ“ä½œèªªæ˜]<br>
                    å…¨å¹³å°æ”¯æ´<br>
                    éµç›¤: æ–¹å‘éµ/Space/Enter<br>
                    æ»‘é¼ /è§¸æ§: é»æ“Šè¢å¹•
                </div>
                <div id="hud-box" style="display:none;">
                    <span style="color:var(--neon-green)">è³‡ç”¢: $ <span id="money">500,000</span></span>
                    <span style="color:var(--neon-pink)">HP: <span id="hp">100%</span></span>
                </div>
                <div id="options-box"></div>
                <div id="dialogue-area" onclick="handleInteraction()" style="display:none;">
                    <div id="name-tag">System</div>
                    <div id="dialogue-text">ç³»çµ±å•Ÿå‹•ä¸­...</div>
                    <div id="next-arrow">â–¼</div>
                </div>
            </div>
        </div>
    </div>

    <div id="mascot-container">
        <img id="mascot-img" src="image/LiyuChillGuy.svg" alt="ç§‹è“‹ä¿å¯¶">
    </div>

    <footer>
        Copyright Â© Liyuchiutiger Gongminshen
    </footer>

    <script>
        /* === 0. éŸ³æ•ˆèˆ‡ç‰¹æ•ˆç³»çµ± === */
        const AudioSys = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
                osc.stop(this.ctx.currentTime + duration);
            },
            playSFX: function(name) {
                if (!this.ctx) return;
                switch(name) {
                    case 'type': this.playTone(600, 'square', 0.05, 0.02); break;
                    case 'move': this.playTone(300, 'square', 0.05, 0.05); break;
                    case 'select': this.playTone(550, 'square', 0.1, 0.1); break;
                    case 'correct': this.playTone(880, 'square', 0.1, 0.1); setTimeout(()=>this.playTone(1100, 'square', 0.2, 0.1), 100); break;
                    case 'wrong': this.playTone(150, 'sawtooth', 0.3, 0.2); setTimeout(()=>this.playTone(100, 'sawtooth', 0.3, 0.2), 150); break;
                    case 'win': [523, 659, 783, 1046, 1318, 1568].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2, 0.1), i * 120)); break;
                    case 'damage': this.playTone(100, 'sawtooth', 0.3, 0.3); this.playTone(80, 'square', 0.4, 0.3); break;
                    case 'cash': this.playTone(1200, 'sine', 0.1, 0.1); setTimeout(()=>this.playTone(1800, 'square', 0.2, 0.1), 50); break;
                    case 'card_flip': this.playTone(400, 'triangle', 0.1, 0.1); break;
                }
            }
        };

        const FX = {
            shake: function() {
                const wrapper = document.getElementById('game-wrapper');
                wrapper.classList.remove('shake-anim');
                void wrapper.offsetWidth; 
                wrapper.classList.add('shake-anim');
                AudioSys.playSFX('damage');
            },
            floatingText: function(text, color) {
                const el = document.createElement('div');
                el.className = 'floating-text';
                el.innerText = text;
                el.style.color = color;
                el.style.left = (400 + Math.random()*100 - 50) + 'px';
                el.style.top = (300 + Math.random()*100 - 50) + 'px';
                document.getElementById('game-wrapper').appendChild(el);
                setTimeout(() => el.remove(), 1500);
                if(color === 'lime' || color === 'gold') AudioSys.playSFX('cash');
            }
        };

        /* === 1. éŠæˆ²æ ¸å¿ƒç‹€æ…‹ === */
        const Game = {
            state: 'start', money: 500000, hp: 100, currentScene: 'chance_1_start',
            isTyping: false, fullText: '', typingTimer: null, 
            currentOptions: [], selectedOptionIndex: 0, 
            cardCursorIndex: 0, mapCursorIndex: 0, 
            hazardCursorIndex: 0, crackCursorIndex: 0, memoryCursorIndex: 0,
            returnScene: '', insuranceType: 'none',
            // éŠæˆ²ç‹€æ…‹è®Šæ•¸
            memoryCards: [], flippedCards: [], matchedCount: 0,
            hazardsFound: 0, keypadValue: "", balancePos: 50, balanceVel: 0, debrisHealth: 5,
            extPos: 0, extDir: 1, extSuccess: 0, extTimer: null,
            fallingTimer: null, fallingSpawnTimer: null, catcherX: 350, itemsCaught: 0,
            reflexTimer: null, reflexTarget: '', reflexScore: 0,
            crackCount: 0, cracksFixed: 0,
            docValid: false, docScore: 0
        };

        function startGame() {
            AudioSys.init();
            AudioSys.playSFX('select');
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('hud-box').style.display = 'flex';
            document.getElementById('dialogue-area').style.display = 'flex';
            triggerChanceGame('intro_1');
        }

        function updateUI() {
            document.getElementById('money').innerText = Game.money.toLocaleString();
            document.getElementById('hp').innerText = Game.hp + "%";
            document.getElementById('hp').style.color = Game.hp > 50 ? 'lime' : 'red';
        }

        /* === 2. æ§åˆ¶å™¨ === */
        document.addEventListener('keydown', (e) => {
            // 1. å•Ÿå‹•ç•«é¢
            if (Game.state === 'start') {
                if (e.key === 'Enter' || e.key === ' ') {
                    startGame();
                }
                return;
            }

            // 2. ç‰¹æ®Šå°éŠæˆ²é‚è¼¯ - éµç›¤æ”¯æ´
            if (Game.state === 'game_extinguisher' || Game.state === 'game_debris') {
                if (e.key === ' ' || e.key === 'Enter') {
                    if(Game.state === 'game_extinguisher') checkExtinguisherHit(); 
                    if(Game.state === 'game_debris') hitDebris();
                }
                return;
            }
            
            if (Game.state === 'game_balance') {
                if (e.key === 'ArrowLeft') Game.balanceVel -= 0.8;
                if (e.key === 'ArrowRight') Game.balanceVel += 0.8;
                return;
            }

            if (Game.state === 'game_keypad') {
                if (e.key >= '0' && e.key <= '9') keypadInput(parseInt(e.key));
                if (e.key === 'Backspace') keypadInput('C');
                if (e.key === 'Enter') keypadInput('E');
                return;
            }

            if (Game.state === 'game_falling') {
                if (e.key === 'ArrowLeft') Game.catcherX = Math.max(0, Game.catcherX - 25);
                if (e.key === 'ArrowRight') Game.catcherX = Math.min(700, Game.catcherX + 25);
                document.getElementById('catcher-box').style.left = Game.catcherX + 'px';
                return;
            }

            if (Game.state === 'game_reflex') {
                checkReflexInput(e.key);
                return;
            }

            if (Game.state === 'game_stamper') {
                if (e.key === 'ArrowLeft') checkDoc(true);
                if (e.key === 'ArrowRight') checkDoc(false);
                return;
            }

            // æ‰¾ç¢´éŠæˆ² - éµç›¤æ¸¸æ¨™
            if (Game.state === 'game_hazard') {
                const hazards = Array.from(document.querySelectorAll('.hazard-target')).filter(el => el.style.display !== 'none');
                if(hazards.length === 0) return;
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    Game.hazardCursorIndex = (Game.hazardCursorIndex + 1) % hazards.length;
                    AudioSys.playSFX('move');
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    Game.hazardCursorIndex = (Game.hazardCursorIndex - 1 + hazards.length) % hazards.length;
                    AudioSys.playSFX('move');
                } else if (e.key === 'Enter' || e.key === ' ') {
                    foundHazard(hazards[Game.hazardCursorIndex]);
                    Game.hazardCursorIndex = 0;
                }
                
                // Update visuals
                document.querySelectorAll('.hazard-target').forEach(el => el.classList.remove('selected-target'));
                if(hazards[Game.hazardCursorIndex]) hazards[Game.hazardCursorIndex].classList.add('selected-target');
                return;
            }

            // ä¿®è£œéŠæˆ² - éµç›¤æ¸¸æ¨™
            if (Game.state === 'game_crack') {
                const cracks = document.querySelectorAll('.wall-crack');
                if(cracks.length === 0) return;
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    Game.crackCursorIndex = (Game.crackCursorIndex + 1) % cracks.length;
                    AudioSys.playSFX('move');
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    Game.crackCursorIndex = (Game.crackCursorIndex - 1 + cracks.length) % cracks.length;
                    AudioSys.playSFX('move');
                } else if (e.key === 'Enter' || e.key === ' ') {
                    if(cracks[Game.crackCursorIndex]) cracks[Game.crackCursorIndex].click();
                }

                document.querySelectorAll('.wall-crack').forEach(el => el.classList.remove('selected-target'));
                if(cracks[Game.crackCursorIndex]) cracks[Game.crackCursorIndex].classList.add('selected-target');
                return;
            }

            // è¨˜æ†¶éŠæˆ² - éµç›¤æ¸¸æ¨™
            if (Game.state === 'memory') {
                const cards = document.querySelectorAll('.memory-card');
                let moved = false;
                if (e.key === 'ArrowRight') { Game.memoryCursorIndex = Math.min(cards.length-1, Game.memoryCursorIndex + 1); moved = true; }
                else if (e.key === 'ArrowLeft') { Game.memoryCursorIndex = Math.max(0, Game.memoryCursorIndex - 1); moved = true; }
                else if (e.key === 'ArrowDown') { Game.memoryCursorIndex = Math.min(cards.length-1, Game.memoryCursorIndex + 4); moved = true; }
                else if (e.key === 'ArrowUp') { Game.memoryCursorIndex = Math.max(0, Game.memoryCursorIndex - 4); moved = true; }
                else if (e.key === 'Enter' || e.key === ' ') {
                    if(cards[Game.memoryCursorIndex]) flipMemoryCard(cards[Game.memoryCursorIndex]);
                }
                
                if(moved) AudioSys.playSFX('move');
                
                cards.forEach(el => el.classList.remove('selected-target'));
                if(cards[Game.memoryCursorIndex]) cards[Game.memoryCursorIndex].classList.add('selected-target');
                return;
            }

            // 3. UI ä»‹é¢æ“ä½œ
            if (Game.state === 'card') {
                if (e.key === 'ArrowLeft') { Game.cardCursorIndex = 0; updateCardCursor(); AudioSys.playSFX('move'); }
                else if (e.key === 'ArrowRight') { Game.cardCursorIndex = 1; updateCardCursor(); AudioSys.playSFX('move'); }
                else if (e.key === 'Enter' || e.key === ' ') selectCard(Game.cardCursorIndex);
                return;
            }

            if (Game.state === 'map') {
                e.preventDefault();
                let moved = false;
                if (e.key === 'ArrowUp' && Game.mapCursorIndex >= 3) { Game.mapCursorIndex -= 3; moved = true; }
                else if (e.key === 'ArrowDown' && Game.mapCursorIndex < 6) { Game.mapCursorIndex += 3; moved = true; }
                else if (e.key === 'ArrowLeft' && Game.mapCursorIndex % 3 !== 0) { Game.mapCursorIndex--; moved = true; }
                else if (e.key === 'ArrowRight' && (Game.mapCursorIndex + 1) % 3 !== 0) { Game.mapCursorIndex++; moved = true; }
                else if (e.key === 'Enter' || e.key === ' ') {
                    checkMapSelection(document.querySelectorAll('.map-tile')[Game.mapCursorIndex].dataset.type);
                }
                if(moved) { updateMapCursor(); AudioSys.playSFX('move'); }
                return;
            }

            if (Game.state === 'options') {
                if (e.key === 'ArrowUp') { Game.selectedOptionIndex = Math.max(0, Game.selectedOptionIndex - 1); updateOptionVisuals(); AudioSys.playSFX('move'); }
                else if (e.key === 'ArrowDown') { Game.selectedOptionIndex = Math.min(Game.currentOptions.length - 1, Game.selectedOptionIndex + 1); updateOptionVisuals(); AudioSys.playSFX('move'); }
                else if (e.key === 'Enter' || e.key === ' ') selectOption(Game.selectedOptionIndex);
                return;
            }

            if (Game.state === 'matrix' || Game.state === 'learning') {
                if (e.key === 'Enter' || e.key === ' ' || e.key === 'Escape') {
                    if(Game.state === 'matrix') closeRiskMatrix();
                    else closeLearning();
                }
                return;
            }

            // 4. ä¸€èˆ¬å°è©±
            if (Game.isTyping) {
                if (e.key === 'Enter' || e.key === ' ') finishTyping();
                return;
            }

            if (Game.state === 'dialogue') {
                if (e.key === 'ArrowUp') { document.getElementById('dialogue-text').scrollTop -= 40; e.preventDefault(); }
                else if (e.key === 'ArrowDown') { document.getElementById('dialogue-text').scrollTop += 40; e.preventDefault(); }
                else if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') handleInteraction();
            }
        });

        /* === 3. åŠ‡æœ¬è³‡æ–™åº« === */
        const Scripts = {
            chance_1_start: {},
            intro_1: {
                bg: 'bg-intro', npc: 'ç³»çµ±é€šçŸ¥',
                text: 'ã€æ–°éƒµä»¶é€šçŸ¥ã€‘\nå¯„ä»¶è€…ï¼šç¥ç¥å™ å¾‹å¸«äº‹å‹™æ‰€\nä¸»æ—¨ï¼šéºç”¢ç¹¼æ‰¿é€šçŸ¥\n\né‡‘åˆ©é¤˜æ‚¨å¥½ï¼Œä»¤ç¥–çˆ¶ç•™ä¸‹ä¸€æ£Ÿä½æ–¼æ–·å±¤å¸¶çš„ 40 å¹´é€å¤©å...',
                next: 'intro_2'
            },
            intro_2: {
                bg: 'bg-intro', npc: 'é‡‘åˆ©é¤˜',
                text: '(å›æ†¶æ¹§ç¾) çˆºçˆºçš„è€æˆ¿å­...\nè¨˜å¾—å°æ™‚å€™é‚£è£¡ç™¼ç”Ÿéåœ°éœ‡ï¼Œç‰†å£éƒ½è£‚äº†ã€‚\nç¾åœ¨çœŸçš„è¦æˆ‘å»ä½é‚£è£¡å—ï¼Ÿ',
                next: 'start'
            },
            start: {
                bg: 'bg-street', npc: 'é‡‘åˆ©é¤˜',
                text: 'é›–ç„¶ç ´èˆŠäº†é»ï¼Œä½†çµ‚æ–¼å¯ä»¥ä¸ç”¨å†ç§Ÿæˆ¿é‚„æ˜¯å¾ˆè®šï¼\n(çœ‹è‘—ç‰†å£çš„è£‚ç¸«)\næ¬¸...ä¸éé€™è£‚ç¸«æ˜¯ä¸æ˜¯æœ‰é»å¤§ï¼Ÿ',
                next: 'c1_meet'
            },
            c1_meet: {
                bg: 'bg-street', npc: 'ç§‹é¯‰é­š',
                text: 'YOï¼YOï¼YOï¼é‡‘åˆ©é¤˜ï¼Œå…ˆåˆ¥æ€¥è‘—é–‹å¿ƒã€‚\næˆ‘æ˜¯ä½ çš„é¢¨éšªé¡§å•ã€Œç§‹é¯‰é­šã€ã€‚\né€™æˆ¿å­å±‹é½¡é«˜ã€ä½æ–¼æ–·å±¤å¸¶ï¼Œæ˜¯å…¸å‹çš„ã€Œé¢¨éšªç‚¸å½ˆã€ã€‚',
                next: 'c2_risk_pre'
            },
            c2_risk_pre: {
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š',
                text: 'æˆ‘å€‘ç¾åœ¨é€²å»šæˆ¿çœ‹çœ‹ã€‚\nç­‰ç­‰ï¼æˆ‘æ„Ÿæ‡‰åˆ°é€™è£¡å……æ»¿å±éšªï¼\n(è«‹å¿«é€Ÿæ‰¾å‡º 3 å€‹å±éšªæº)',
                action: () => startHazardGame(), next: null
            },
            c2_risk_hazard_done: {
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š',
                text: 'å¥½çœ¼åŠ›ï¼æ—¢ç„¶ç™¼ç¾å±éšªï¼Œç¾åœ¨ä¾†ç‰¹è¨“å¦‚ä½•ä½¿ç”¨æ»…ç«å™¨ï¼\n(çœ‹åˆ°ç¶ è‰²å€åŸŸæ™‚æŒ‰ç©ºç™½éµ/é»æ“Š)',
                action: () => startExtinguisherGame(), next: null
            },
            c2_ext_done: {
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š',
                text: 'æ»…ç«æŠ€å·§ä¸éŒ¯å˜›ã€‚ä½†æ ¹æœ¬ä¹‹é“é‚„æ˜¯è¦è§£æ±ºè€èˆŠé›»ç·šã€‚\nåœ¨åšæ±ºå®šå‰ï¼Œè®“æˆ‘å…ˆå•Ÿå‹•ã€Œé¢¨éšªç®¡ç†åˆ†æç³»çµ±ã€ã€‚',
                next: 'c2_risk_then'
            },
            c2_risk_then: {
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š',
                text: 'è«‹çœ‹ä»”ç´°ï¼',
                action: () => showRiskMatrix(), next: null
            },
            c2_risk: {
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š',
                text: 'åˆ†æå®Œç•¢ã€‚å»šæˆ¿é›»ç·šè€åŒ–åš´é‡ï¼Œéš¨æ™‚æœƒèµ°ç« (ç™¼ç”Ÿé »ç‡é«˜)ã€‚\næ ¹æ“šå‰›å‰›çš„åœ–è¡¨ï¼Œä½ æ€éº¼é¸ï¼Ÿ',
                options: [
                    { t: 'å¤ªå±éšªï¼Œè³£æˆ¿æ¬å®¶ (é¢¨éšªè¦é¿)', n: 'c2_avoid' },
                    { t: 'èŠ± 8 è¬é‡æ‹‰ç·šè·¯ (é¢¨éšªé™ä½)', n: 'c2_reduce', correct: true },
                    { t: 'è²·æ»…ç«å™¨æ”¾æ—é‚Š (é¢¨éšªè‡ªç•™)', n: 'c2_retain' }
                ]
            },
            c2_avoid: { 
                bg: 'bg-kitchen', npc: 'é‡‘åˆ©é¤˜', text: 'å¤ªå¯æ€•äº†ï¼Œæˆ‘ä¸ä½äº†ï¼...ä½†åŠ‡æƒ…éœ€è¦ï¼Œæˆ‘é‚„æ˜¯å¾—ä½ã€‚', 
                learn: { title: 'é¢¨éšªè¦é¿ (Avoid)', content: 'å®Œå…¨é¿é–‹ç”¢ç”Ÿé¢¨éšªçš„æ´»å‹•ã€‚\nä¾‹å¦‚ï¼šæ‹’çµ•å‰å¾€é«˜é¢¨éšªåœ°å€ã€‚ä½†ç¾å¯¦ä¸­å¾ˆé›£å®Œå…¨è¦é¿å¤©ç½ã€‚' },
                next: 'chance_2_trigger' 
            },
            c2_reduce: { 
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š', text: 'Nice! èŠ±éŒ¢æ¶ˆç½ï¼Œé€™å«ã€Œé¢¨éšªé™ä½ã€ã€‚', action: () => {Game.money-=80000; FX.floatingText('-$80,000', 'red');}, 
                learn: { title: 'é¢¨éšªé™ä½ (Reduce)', content: 'æ¡å–é é˜²æªæ–½(å¦‚æ›´æ›è€èˆŠç·šè·¯ã€å®‰è£ä½è­¦å™¨)é™ä½äº‹æ•…ç™¼ç”Ÿæ©Ÿç‡ã€‚' },
                next: 'chance_2_trigger' 
            },
            c2_retain: { 
                bg: 'bg-kitchen', npc: 'ç§‹é¯‰é­š', text: 'ç«ç½é€™ç¨®å¤§é¢¨éšªç”¨è‡ªç•™ï¼Ÿä½ å¿ƒè‡ŸçœŸå¤§é¡†ã€‚', action: () => {Game.hp-=10; FX.shake(); FX.floatingText('-10 HP', 'red');}, 
                learn: { title: 'é¢¨éšªè‡ªç•™ (Retain)', content: 'è‡ªå·±æ‰¿æ“”æå¤±ã€‚\né€šå¸¸åªé©ç”¨æ–¼ã€Œæå¤±é »ç‡ä½ã€å¹…åº¦å°ã€çš„é¢¨éšªï¼Œæˆ–æº–å‚™äº†ç·Šæ€¥é å‚™é‡‘ã€‚' },
                next: 'chance_2_trigger' 
            },
            chance_2_trigger: {
                bg: 'bg-kitchen', npc: 'å‘½é‹', text: 'æ•´ä¿®å®Œå»šæˆ¿å¾Œï¼Œå‘½é‹åˆä¾†æ•²é–€äº†...', action: () => triggerChanceGame('c2_done'), next: null
            },
            c2_done: {
                bg: 'bg-street', npc: 'ç§‹é¯‰é­š',
                text: 'æå®šé›»ç·šï¼Œé‚„æœ‰åœ°éœ‡ã€‚é€™å±¬æ–¼ã€Œç™¼ç”Ÿç‡ä½ã€æå¤±å¤§ã€çš„é¢¨éšªã€‚\næ ¹æ“šå››è±¡é™åœ–ï¼Œé€™éœ€è¦ã€Œé¢¨éšªç§»è½‰ã€ã€‚\næˆ‘å€‘å»éŠ€è¡Œã€‚',
                next: 'c3_crack_intro'
            },
            c3_crack_intro: {
                bg: 'bg-street', npc: 'é‡‘åˆ©é¤˜',
                text: 'ç­‰ç­‰ï¼Œå‡ºé–€å‰æˆ‘ç™¼ç¾ç‰†å£åˆæœ‰è£‚ç—•äº†ï¼\nè®“æˆ‘å…ˆè£œä¸€ä¸‹ã€‚',
                action: () => startCrackGame(), next: null
            },
            c3_memory_intro: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š',
                text: 'è£œå¾—ä¸éŒ¯ã€‚åœ¨é€²å…¥éŠ€è¡Œè«‡ä¿éšªå‰ï¼Œ\næˆ‘è¦æ¸¬è©¦ä¸€ä¸‹ä½ çš„é¢¨éšªè§€å¿µæ˜¯å¦æ¸…æ™°ã€‚\nå®Œæˆé€™å€‹ç‰¹è¨“æ‰èƒ½ç¹¼çºŒï¼',
                action: () => startMemoryGame(), next: null
            },
            c3_memory_done: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š', text: 'å¾ˆå¥½ï¼è…¦è¢‹å¾ˆæ¸…æ¥šå˜›ã€‚æˆ‘å€‘é€²å»å§ã€‚', next: 'c3_bank'
            },
            c3_bank: {
                bg: 'bg-bank', npc: 'è¡Œå“¡',
                text: 'é‡‘åˆ©é¤˜æ‚¨å¥½ï¼Œè¾¦ç†ç¹¼æ‰¿æˆ¿è²¸ï¼ŒéŠ€è¡Œæœƒè¦æ±‚æŠ•ä¿ã€Œä½å®…ç«ç½åŠåœ°éœ‡åŸºæœ¬ä¿éšªã€ã€‚\né€™æ˜¯ä¸€å¹´æœŸçš„ä¿å–®ã€‚',
                options: [
                    { t: 'æˆ‘ä¸è¦ä¿ï¼ŒçœéŒ¢è®šè®š (æ‹’çµ•)', n: 'c3_refuse' },
                    { t: 'ä¿éšªå¤šä¸€ä»½å®‰å¿ƒï¼ŒæŠ•ä¿å§ (åŒæ„)', n: 'c3_agree', correct: true }
                ]
            },
            c3_refuse: { 
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š', text: 'ä¸è¡Œï¼å› ç‚ºæˆ¿å­é‚„åœ¨è²¸æ¬¾ï¼ŒéŠ€è¡Œç‚ºä¿éšœå‚µæ¬Šï¼Œæœƒè¦æ±‚ä½ å¼·åˆ¶æŠ•ä¿ã€‚\nä¸ä¿çš„è©±éŠ€è¡Œä¹Ÿæœƒä»£ç‚ºæŠ•ä¿ä¸¦æ‰£æ¬¾å–”ã€‚', 
                learn: { title: 'ä½å®…ç«ç½åŠåœ°éœ‡åŸºæœ¬ä¿éšª', content: 'â— æ€§è³ªï¼šæ”¿ç­–æ€§ä¿éšªã€‚\nâ— ç›®çš„ï¼šæ¸›è¼•åœ°éœ‡ç½æè² æ“”ã€‚\nâ— éŠ€è¡Œè²¸æ¬¾æ™‚é€šå¸¸ç‚ºå¿…è¦æ¢ä»¶ã€‚' },
                next: 'c3_myth' 
            },
            c3_agree: { 
                bg: 'bg-bank', npc: 'é‡‘åˆ©é¤˜', text: 'å¥½å§ï¼Œç‚ºäº†æˆ¿å­...', 
                learn: { title: 'ä½å®…ç«ç½åŠåœ°éœ‡åŸºæœ¬ä¿éšª', content: 'â— å…¨å°å–®ä¸€è²»ç‡ï¼Œæ¯å¹´ç´„ 1,350 å…ƒã€‚\nâ— åŒ…å«ç«ç½éšªèˆ‡åœ°éœ‡åŸºæœ¬éšªã€‚' },
                next: 'c3_myth' 
            },
            c3_myth: {
                bg: 'bg-bank', npc: 'é‡‘åˆ©é¤˜', text: 'é€™æˆ¿å­é€™éº¼èˆŠï¼Œä¿éšªæœƒè³ å—ï¼Ÿé‚„æ˜¯éš¨ä¾¿è³ ä¸€é»ï¼Ÿ', next: 'c3_myth_ans'
            },
            c3_myth_ans: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š', text: 'æ”¾å¿ƒï¼ç†è³ æ˜¯ä¾ã€Œé‡ç½®æˆæœ¬ã€è¨ˆç®—ï¼Œä¸æ‰£æŠ˜èˆŠï¼\nä¹Ÿå°±æ˜¯æŠŠä½ æˆ¿å­è“‹å›ä¾†çš„éŒ¢ï¼Œä¸æ˜¯çœ‹å¸‚åƒ¹å–”ã€‚',
                learn: { title: 'é‡ç½®æˆæœ¬ (Replacement Cost)', content: 'æŒ‡é‡æ–°å»ºé€ æˆ–ä¿®å¾©æ‰€éœ€çš„æˆæœ¬ã€‚\nåœ°éœ‡éšªç†è³ ä¸æ‰£é™¤æŠ˜èˆŠï¼Œå°è€å±‹æ›´æœ‰ä¿éšœã€‚\næ³¨æ„ï¼šä¸åŒ…å«åœŸåœ°åƒ¹å€¼ã€‚' },
                next: 'c4_upgrade_intro'
            },
            c4_upgrade_intro: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š',
                text: 'è¦é€²å…¥ VIP å®¤äº†è§£é€²éšæ–¹æ¡ˆï¼Œä½ éœ€è¦è¼¸å…¥ã€Œä½å®…åœ°éœ‡åŸºæœ¬ä¿éšªã€çš„å¹´ä¿è²»é‡‘é¡ç•¶ä½œå¯†ç¢¼ã€‚\n(æç¤º: ä¸€åƒä¸‰ç™¾...)',
                action: () => startKeypadGame(), next: null
            },
            c4_keypad_done: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š',
                text: 'æ²’éŒ¯ï¼å…¨å°å–®ä¸€è²»ç‡ 1350 å…ƒã€‚\næ³¨æ„ï¼ŒåŸºæœ¬éšªæœ€é«˜åªè³  150 è¬ï¼Œä¸”è¦ã€Œå…¨å€’/åŠå€’ã€æ‰è³ ã€‚\næ‰€ä»¥æœ‰å…¶ä»–é€²éšä¿éšªå¯é¸ï¼š',
                learn: { title: 'å››ç¨®åœ°éœ‡ä¿éšªæ¯”è¼ƒ', content: '1. åœ°éœ‡åŸºæœ¬éšªï¼šæœ€é«˜ 150 è¬ (å…¨å€’/åŠå€’)ã€‚\n2. è¶…é¡åœ°éœ‡éšªï¼šæé«˜ç†è³ é¡åº¦ (ä»éœ€å…¨å€’)ã€‚\n3. è¼•æåœ°éœ‡éšªï¼šè³ å„Ÿéƒ¨åˆ†æå£ (å¦‚ç‰†å£é¾œè£‚ã€è£æ½¢)ã€‚\n4. æ“´å¤§åœ°éœ‡éšªï¼šæœ€å…¨é¢ï¼å«å‹•ç”¢ã€è£æ½¢ã€è¼•æï¼Œä¸”ä¸éœ€å…¨å€’ã€‚' },
                next: 'c4_choose'
            },
            c4_choose: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š', text: 'ä½ è¦æ€éº¼é¸æ“‡ï¼Ÿ',
                options: [
                    { t: 'åŸºæœ¬éšªå°±å¥½ (çœéŒ¢)', n: 'c4_basic', action: () => {Game.money-=1350; Game.insuranceType='basic'; FX.floatingText('-$1,350', 'red');} },
                    { t: 'åŠ ä¿ã€Œè¼•æåœ°éœ‡éšªã€(æ€•ç‰†å£è£‚)', n: 'c4_light', action: () => {Game.money-=3000; Game.insuranceType='light'; FX.floatingText('-$3,000', 'red');} },
                    { t: 'åŠ ä¿ã€Œæ“´å¤§åœ°éœ‡éšªã€(å…¨åŒ…äº†)', n: 'c4_expand', correct: true, action: () => {Game.money-=6350; Game.insuranceType='expanded'; FX.floatingText('-$6,350', 'red');} }
                ]
            },
            c4_basic: { bg: 'bg-bank', npc: 'ç³»çµ±', text: 'é¸æ“‡åŸºæœ¬éšªã€‚', next: 'chance_3_trigger' },
            c4_light: { bg: 'bg-bank', npc: 'ç³»çµ±', text: 'é¸æ“‡è¼•æéšªã€‚', next: 'chance_3_trigger' },
            c4_expand: { bg: 'bg-bank', npc: 'ç³»çµ±', text: 'é¸æ“‡æ“´å¤§éšªã€‚', next: 'chance_3_trigger' },
            
            chance_3_trigger: {
                bg: 'bg-bank', npc: 'å‘½é‹', text: 'èµ°å‡ºéŠ€è¡Œï¼Œå¿ƒæƒ…å¿å¿‘...', action: () => triggerChanceGame('c5_bag'), next: null
            },
            c5_bag: {
                bg: 'bg-room', npc: 'ç§‹é¯‰é­š', text: 'å›å®¶æº–å‚™ã€Œç·Šæ€¥é¿é›£åŒ…ã€ã€‚\nè«‹é¸å‡ºä¸€å€‹ã€Œä¸éœ€è¦ã€æ”¾åœ¨åŒ…åŒ…è£¡çš„æ±è¥¿ï¼š',
                options: [
                    { t: 'æ°´èˆ‡ä¹¾ç³§ (3æ—¥ä»½)', n: 'c5_wrong' },
                    { t: 'PS5 éŠæˆ²æ©Ÿ', n: 'c5_right', correct: true },
                    { t: 'èº«åˆ†è­‰ä»¶èˆ‡ç¾é‡‘', n: 'c5_wrong' }
                ]
            },
            c5_wrong: { bg: 'bg-room', npc: 'ç§‹é¯‰é­š', text: 'é€™æ˜¯å¿…å‚™å“ï¼å†é¸ä¸€æ¬¡ã€‚', next: 'c5_bag' },
            c5_right: { 
                bg: 'bg-room', npc: 'é‡‘åˆ©é¤˜', text: 'å¤ªé‡äº†ï¼Œé€ƒå‘½è¦ç·Šï¼ŒPS5 å…ˆä¸è¦ã€‚', 
                learn: { title: 'ç·Šæ€¥é¿é›£åŒ…', content: 'æ‡‰æ”¾ç½®æ–¼é–€å£æˆ–ç„é—œéš¨æ‰‹å¯æ‹¿è™•ã€‚\nå…§å®¹ï¼šæ°´/é£Ÿç‰©(3å¤©)ã€æ€¥æ•‘åŒ…ã€ä¿æš–è¡£ç‰©ã€æ‰‹é›»ç­’ã€é›»æ± ã€å“¨å­ã€è­‰ä»¶å½±æœ¬ã€å°‘è¨±ç¾é‡‘ã€‚' },
                next: 'c5_falling' 
            },
            c5_falling: {
                bg: 'bg-room', npc: 'ç§‹é¯‰é­š', text: 'èªªåˆ°ç‰©è³‡ï¼Œæˆ‘å€‘ä¾†ç·´ç¿’å¿«é€Ÿæ”¶é›†ç‰©è³‡å§ï¼\n(æ¥æ°´å’Œé£Ÿç‰©ï¼Œé¿é–‹çŸ³é ­)',
                action: () => startFallingGame(), next: null
            },
            c6_map_start: {
                bg: 'bg-room', npc: 'ç§‹é¯‰é­š',
                text: 'ç‰©è³‡å‚™é½Šäº†ã€‚ç¾åœ¨ä¾†æ¨¡æ“¬æ¼”ç·´ã€‚\nå¦‚æœç™¼ç”Ÿå¤§åœ°éœ‡ï¼Œæˆ‘å€‘è¦å»å“ªè£¡é¿é›£ï¼Ÿ\nè«‹åœ¨åœ°åœ–ä¸­é¸å‡ºæ­£ç¢ºçš„ã€Œé¿é›£æ”¶å®¹è™•æ‰€ã€ã€‚',
                action: () => startMapGame(), next: null 
            },
            c6_map_done: {
                bg: 'bg-street', npc: 'ç§‹é¯‰é­š', text: 'åšå¾—å¥½ï¼å…¬åœ’ã€å­¸æ ¡ã€æ´»å‹•ä¸­å¿ƒé€šå¸¸æ˜¯é¿é›£æ”¶å®¹è™•æ‰€ã€‚', next: 'chance_4_trigger'
            },
            chance_4_trigger: {
                bg: 'bg-street', npc: 'å‘½é‹', text: 'æœ€çµ‚åœ°éœ‡ä¾†è‡¨å‰...', action: () => triggerChanceGame('c7_quake_pre'), next: null
            },
            c7_quake_pre: {
                bg: 'bg-house', npc: 'è­¦å ±', text: 'âš ï¸ å¼·çƒˆåœ°éœ‡ä¾†è¥²ï¼æˆ¿å­åŠ‡çƒˆæ–æ™ƒï¼âš ï¸\nå¿«ä¿æŒå¹³è¡¡ï¼Œä¸è¦è·Œå€’ï¼',
                action: () => startBalanceGame(), next: null
            },
            c7_quake: {
                bg: 'bg-house', npc: 'è­¦å ±', text: 'éœ‡å‹•æŒçºŒä¸­ï¼ç¾åœ¨è©²æ€éº¼åšï¼Ÿ',
                options: [
                    { t: 'è¡å»é–‹é–€é€ƒè·‘', n: 'c7_bad' },
                    { t: 'è¶´ä¸‹ã€æ©è­·ã€ç©©ä½', n: 'c7_good', correct: true }
                ]
            },
            c7_bad: { 
                bg: 'bg-house', npc: 'ç§‹é¯‰é­š', text: 'å±éšªï¼ç§»å‹•å®¹æ˜“è¢«æ‰è½ç‰©ç ¸å‚·ï¼(HP-30)', action: () => {Game.hp-=30; FX.shake(); FX.floatingText('-30 HP', 'red');}, 
                learn: { title: 'æŠ—éœ‡ä¿å‘½ä¸‰æ­¥é©Ÿ', content: '1. è¶´ä¸‹ (Drop)\n2. æ©è­· (Cover)\n3. ç©©ä½ (Hold on)\nä¿è­·é ­é ¸éƒ¨æ˜¯æœ€é«˜åŸå‰‡ã€‚' },
                next: 'c7_reflex_intro' 
            },
            c7_good: { 
                bg: 'bg-house', npc: 'ç³»çµ±', text: 'å®Œç¾é˜²ç¦¦ï¼èº²åœ¨æ¡Œä¸‹ä¿è­·äº†é ­é ¸éƒ¨ï¼', 
                learn: { title: 'æŠ—éœ‡ä¿å‘½ä¸‰æ­¥é©Ÿ', content: '1. è¶´ä¸‹ (Drop)\n2. æ©è­· (Cover)\n3. ç©©ä½ (Hold on)\nåœ°éœ‡æ™‚å‹¿æ…Œå¼µå¾€å¤–è¡ã€‚' },
                next: 'c7_reflex_intro' 
            },
            c7_reflex_intro: {
                bg: 'bg-ruins', npc: 'è­¦å ±', text: 'åœ°éœ‡ç¨åœï¼Œè«‹ä¾ç…§æŒ‡ç¤ºæ–¹å‘ç–æ•£ï¼',
                action: () => startReflexGame(), next: null
            },
            chance_5_trigger: {
                bg: 'bg-ruins', npc: 'å‘½é‹', text: 'ä¸»éœ‡çµæŸäº†ï¼Œä½†åœ¨é¤˜éœ‡ä¸­...', action: () => triggerChanceGame('c8_ruin_pre'), next: null
            },
            c8_ruin_pre: {
                bg: 'bg-ruins', npc: 'é‡‘åˆ©é¤˜', text: 'å’³å’³... åˆ°è™•éƒ½æ˜¯ç“¦ç¤«ã€‚\næˆ‘çš„ä¿éšªå–®åœ¨å“ªè£¡ï¼Ÿ\n(è«‹é»æ“Šç“¦ç¤«å †ï¼Œæ‰¾å‡ºä¿å–®)',
                action: () => startDebrisGame(), next: null
            },
            c8_ruin: {
                bg: 'bg-ruins', npc: 'é‡‘åˆ©é¤˜', text: 'æ‰¾åˆ°äº†ï¼\nä½†æˆ¿å­æ­ªäº†ä¸€é‚Šï¼Œé„°å±…è·‘ä¾†èªªæˆ‘å®¶å¤±ç«ç‡’åˆ°ä»–å®¶ï¼Œè¦æˆ‘è³ éŒ¢ï¼', next: 'c9_liability'
            },
            c9_liability: {
                bg: 'bg-ruins', npc: 'ç§‹é¯‰é­š', text: 'åˆ¥æ€•ã€‚ä½å®…ç«ç½ä¿éšªåŒ…å«ã€Œç¬¬ä¸‰äººè²¬ä»»éšªã€ã€‚\nä¿éšªå…¬å¸æœƒå¹«ä½ è³ é„°å±…ï¼',
                learn: { title: 'ä½å®…ç¬¬ä¸‰äººè²¬ä»»åŸºæœ¬ä¿éšª', content: 'æŠ•ä¿ä½å®…ç«éšªè‡ªå‹•äº«æœ‰ã€‚\nä¿éšœå› ç«ç½å»¶ç‡’å°è‡´ç¬¬ä¸‰äºº(é„°å±…)å—å‚·æˆ–è²¡æã€‚' },
                next: 'c10_claim_intro'
            },
            c10_claim_intro: {
                bg: 'bg-bank', npc: 'è¡Œå“¡', text: 'è«‹å”åŠ©å¯©æ ¸ç†è³ æ–‡ä»¶ã€‚\n(æœ‰è“‹ç« çš„æ‰èƒ½é€šé)',
                action: () => startStamperGame(), next: null
            },
            c10_claim_done: {
                bg: 'bg-bank', npc: 'ç³»çµ±', text: 'æ–‡ä»¶å¯©æ ¸é€šéã€‚é–‹å§‹ç†è³ çµç®—...\n1. å»ºç‰©æå¤± (ä¾ä¿å–®é¡å‹)\n2. è‡¨æ™‚ä½å®¿è²»ç”¨', next: 'c11_priority'
            },
            c11_priority: {
                bg: 'bg-bank', npc: 'ç§‹é¯‰é­š', text: 'æ³¨æ„ï¼šå¦‚æœä½ æœ‰æˆ¿è²¸ï¼Œåœ°éœ‡åŸºæœ¬éšªç†è³ é‡‘ (150è¬å…§) æœƒå„ªå…ˆå„Ÿé‚„çµ¦éŠ€è¡Œã€‚',
                learn: { title: 'ç†è³ å„ªå…ˆé †ä½', content: 'è‹¥æˆ¿å±‹æœ‰è¨­å®šæŠµæŠ¼æ¬Š(æˆ¿è²¸)ï¼Œåœ°éœ‡åŸºæœ¬éšªç†è³ é‡‘æœƒå„ªå…ˆå„Ÿé‚„éŠ€è¡Œæ¬ æ¬¾ã€‚' },
                next: 'c12_new_rule'
            },
            c12_new_rule: {
                bg: 'bg-bank', npc: 'ç³»çµ±å¿«è¨Š', text: 'ã€2025å¹´ æ–°åˆ¶é€šçŸ¥ã€‘\nç¬¦åˆã€Œç´…å–®ã€å±éšªå»ºç¯‰ï¼Œå¯é ˜å–è‡¨æ™‚ä½å®¿è²»ï¼',
                action: () => { Game.money += 100000; FX.floatingText('+$100,000', 'gold'); },
                learn: { title: '114å¹´æ–°åˆ¶', content: 'è‡ª 114/7/15 èµ·ï¼š\nè‹¥æˆ¿å±‹ç¶“ç·Šæ€¥è©•ä¼°å¼µè²¼ã€Œç´…è‰²å±éšªæ¨™èªŒã€ï¼Œ\nä¿éšªå…¬å¸æ”¯ä»˜è‡¨æ™‚ä½å®¿è²» 10 è¬å…ƒ (æœ€é«˜ 20 è¬)ã€‚' },
                next: 'c13_final_calc'
            },
            c13_final_calc: {
                bg: 'bg-street', npc: 'ç³»çµ±', text: 'æ­£åœ¨è¨ˆç®—æœ€çµ‚çµæœ...',
                next: () => {
                    if (Game.insuranceType === 'expanded') return 'end_rich';
                    if (Game.insuranceType === 'light') return 'end_okay';
                    return 'end_poor';
                }
            },
            end_rich: {
                bg: 'bg-street', npc: 'é‡‘åˆ©é¤˜', text: 'å¤ªç¥å•¦ï¼å› ç‚ºä¿äº†ã€Œæ“´å¤§åœ°éœ‡éšªã€ï¼\né‡å»ºä¹‹è·¯æ²’å•é¡Œï¼', action: () => triggerCongrats(), stop: true
            },
            end_okay: {
                bg: 'bg-street', npc: 'é‡‘åˆ©é¤˜', text: 'é‚„å¥½æœ‰ã€Œè¼•æåœ°éœ‡éšªã€ï¼Œå‹‰å¼·æ’å¾—éå»ã€‚', action: () => triggerCongrats(), stop: true
            },
            end_poor: {
                bg: 'bg-street', npc: 'é‡‘åˆ©é¤˜', text: 'æ…˜äº†... åªæœ‰ã€ŒåŸºæœ¬éšªã€ã€‚\nå¤§éƒ¨åˆ†éŒ¢é‚„çµ¦éŠ€è¡Œäº†...', action: () => triggerCongrats(), stop: true
            }
        };

        /* === 4. æ ¸å¿ƒé‚è¼¯ & éŠæˆ²æµç¨‹ === */
        function renderScene() {
            updateUI();
            let sceneKey = Game.currentScene;
            if (typeof sceneKey === 'function') sceneKey = sceneKey();
            const data = Scripts[sceneKey];
            
            if (data.action) data.action();
            if (data.bg) document.getElementById('scene-layer').className = data.bg;

            const kin = document.getElementById('char-kin');
            const chill = document.getElementById('char-chill');
            kin.className = `char-img char-visible ${data.npc==='é‡‘åˆ©é¤˜'?'speaking':'not-speaking'}`;
            chill.className = `char-img char-visible ${data.npc==='ç§‹é¯‰é­š'?'speaking':'not-speaking'}`;
            if(data.npc !== 'é‡‘åˆ©é¤˜' && data.npc !== 'ç§‹é¯‰é­š') {
                kin.className = 'char-img char-visible not-speaking';
                chill.className = 'char-img char-visible not-speaking';
            }

            document.getElementById('name-tag').innerText = data.npc;
            document.getElementById('dialogue-text').innerText = '';
            document.getElementById('next-arrow').style.display = 'none';
            document.getElementById('options-box').innerHTML = ''; 
            
            if (data.stop) {
                document.getElementById('dialogue-text').innerText = data.text;
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = 'é‡æ–°é–‹å§‹';
                btn.onclick = () => location.reload();
                document.getElementById('options-box').appendChild(btn);
                Game.state = 'end';
                return;
            }

            // è‹¥åœ¨å°éŠæˆ²ç‹€æ…‹å‰‡åœæ­¢æ–‡å­—
            if (['card', 'map', 'matrix', 'memory', 'game_hazard', 'game_extinguisher', 'game_keypad', 'game_crack', 'game_falling', 'game_reflex', 'game_balance', 'game_debris', 'game_stamper'].includes(Game.state)) {
                document.getElementById('dialogue-text').innerText = data.text || '';
                Game.isTyping = false;
                return; 
            }

            Game.fullText = data.text;
            Game.isTyping = true;
            Game.state = 'dialogue'; 
            
            let charIndex = 0;
            function type() {
                if (!Game.isTyping) return;
                if (charIndex < Game.fullText.length) {
                    const textElem = document.getElementById('dialogue-text');
                    textElem.innerText += Game.fullText.charAt(charIndex);
                    textElem.scrollTop = textElem.scrollHeight;
                    if(charIndex % 3 === 0) AudioSys.playSFX('type');
                    charIndex++;
                    Game.typingTimer = setTimeout(type, 30);
                } else {
                    finishTyping();
                }
            }
            type();
        }

        function finishTyping() {
            clearTimeout(Game.typingTimer);
            Game.isTyping = false;
            document.getElementById('dialogue-text').innerText = Game.fullText;
            const data = Scripts[Game.currentScene];
            if (data.learn && !data.learnShown) {
                data.learnShown = true; showLearningCard(data.learn); return;
            }
            if (data.options) { showOptions(data.options); } 
            else if (data.next !== null) { document.getElementById('next-arrow').style.display = 'block'; Game.state = 'dialogue'; }
        }

        function handleInteraction() {
            if (['learning', 'map', 'matrix', 'card', 'memory', 'game_hazard', 'game_extinguisher', 'game_crack', 'game_falling', 'game_reflex', 'game_balance', 'game_debris', 'game_stamper'].includes(Game.state)) return;
            if (Game.isTyping) { finishTyping(); return; }
            if (Game.state === 'options') return;
            const data = Scripts[Game.currentScene];
            if(data.learnShown) delete data.learnShown;
            if(data.next) {
                AudioSys.playSFX('select');
                if (typeof data.next === 'function') Game.currentScene = data.next();
                else Game.currentScene = data.next;
                renderScene();
            }
        }

        function showOptions(opts) {
            Game.state = 'options'; Game.currentOptions = opts; Game.selectedOptionIndex = 0; 
            const box = document.getElementById('options-box'); box.innerHTML = '';
            opts.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn'; btn.innerText = opt.t;
                btn.onclick = (e) => { e.stopPropagation(); selectOption(index); };
                btn.onmouseenter = () => { Game.selectedOptionIndex = index; updateOptionVisuals(); }
                box.appendChild(btn);
            });
            updateOptionVisuals();
        }

        function updateOptionVisuals() {
            document.querySelectorAll('.option-btn').forEach((btn, idx) => {
                if (idx === Game.selectedOptionIndex) btn.classList.add('selected'); else btn.classList.remove('selected');
            });
        }

        function selectOption(index) {
            const opt = Game.currentOptions[index];
            if (!opt) return;
            if (opt.action) opt.action();
            if (opt.correct) AudioSys.playSFX('correct'); else if (opt.correct === false) AudioSys.playSFX('wrong'); else AudioSys.playSFX('select');
            Game.state = 'dialogue'; document.getElementById('options-box').innerHTML = '';
            Game.currentScene = opt.n; renderScene();
        }

        /* === 5. å„å¼å°éŠæˆ²é‚è¼¯ === */
        
        // 1. å±éšªæºæ‰¾ç¢´ (ä¿®æ­£ç‰ˆ)
        function startHazardGame() {
            Game.state = 'game_hazard'; Game.hazardsFound = 0; Game.hazardCursorIndex = 0;
            document.getElementById('hazard-game-overlay').style.display = 'block';
            document.querySelectorAll('.hazard-target').forEach(el => {
                el.style.display = 'flex';
                el.classList.remove('selected-target');
            });
            // Initial selection for keyboard
            document.querySelectorAll('.hazard-target')[0].classList.add('selected-target');
        }
        function foundHazard(el) {
            if(el.style.display === 'none') return;
            el.style.display = 'none'; Game.hazardsFound++; AudioSys.playSFX('correct'); FX.floatingText('ç™¼ç¾å±éšª!', 'red');
            if(Game.hazardsFound >= 3) {
                setTimeout(() => {
                    document.getElementById('hazard-game-overlay').style.display = 'none';
                    Game.currentScene = 'c2_risk_hazard_done'; Game.state = 'dialogue'; renderScene();
                }, 1000);
            }
        }

        // 2. æ»…ç«å™¨ç¯€å¥éŠæˆ²
        function startExtinguisherGame() {
            Game.state = 'game_extinguisher'; Game.extPos = 0; Game.extDir = 2; Game.extSuccess = 0;
            document.getElementById('extinguisher-game-overlay').style.display = 'flex';
            document.getElementById('ext-msg').innerText = "æº–å‚™...";
            
            // é»æ“Šäº‹ä»¶æ”¯æ´
            document.getElementById('extinguisher-game-overlay').onclick = checkExtinguisherHit;

            Game.extTimer = setInterval(() => {
                Game.extPos += Game.extDir;
                if (Game.extPos > 100 || Game.extPos < 0) Game.extDir *= -1;
                document.getElementById('gauge-cursor').style.left = Game.extPos + '%';
            }, 20);
        }
        function checkExtinguisherHit(e) {
            if(e) e.stopPropagation();
            // 42%~58% æ˜¯ä¸­å¿ƒç¶ è‰²å€åŸŸ (Target width 100px on 600px container approx 16%)
            const hit = (Game.extPos >= 42 && Game.extPos <= 58);
            if(hit) {
                Game.extSuccess++; AudioSys.playSFX('correct');
                document.getElementById('ext-msg').innerText = `å‘½ä¸­! ${Game.extSuccess}/3`;
                document.getElementById('ext-msg').style.color = "lime";
            } else {
                AudioSys.playSFX('wrong');
                document.getElementById('ext-msg').innerText = "æœªå‘½ä¸­!";
                document.getElementById('ext-msg').style.color = "red";
            }
            if(Game.extSuccess >= 3) {
                clearInterval(Game.extTimer);
                document.getElementById('extinguisher-game-overlay').onclick = null;
                setTimeout(() => {
                    document.getElementById('extinguisher-game-overlay').style.display = 'none';
                    Game.currentScene = 'c2_ext_done'; Game.state = 'dialogue'; renderScene();
                }, 1000);
            }
        }

        // 3. ç‰†å£ä¿®è£œéŠæˆ²
        function startCrackGame() {
            Game.state = 'game_crack'; Game.cracksFixed = 0; Game.crackCount = 0; Game.crackCursorIndex = 0;
            const overlay = document.getElementById('crack-game-overlay');
            overlay.innerHTML = '<div style="position:absolute; top:20px; width:100%; text-align:center; font-size:2rem; color:red; font-weight:bold;">!! é»æ“Š/é¸å–ä¿®è£œ 5 å€‹è£‚ç¸« !!</div>';
            overlay.style.display = 'block';
            
            let spawnInterval = setInterval(() => {
                if (Game.cracksFixed >= 5) { clearInterval(spawnInterval); return; }
                if (Game.crackCount < 5) {
                    const crack = document.createElement('div');
                    crack.className = 'wall-crack';
                    crack.innerText = 'âš¡';
                    crack.style.left = (Math.random() * 600 + 50) + 'px';
                    crack.style.top = (Math.random() * 400 + 50) + 'px';
                    crack.onclick = () => {
                        crack.remove(); AudioSys.playSFX('move'); FX.floatingText('ä¿®è£œ!', 'lime');
                        Game.cracksFixed++;
                        // Adjust cursor if element removed
                        const remaining = document.querySelectorAll('.wall-crack');
                        if(remaining.length > 0) {
                            Game.crackCursorIndex = 0;
                            remaining[0].classList.add('selected-target');
                        }

                        if (Game.cracksFixed >= 5) {
                            setTimeout(() => {
                                overlay.style.display = 'none';
                                Game.currentScene = 'c3_memory_intro'; Game.state = 'dialogue'; renderScene();
                            }, 500);
                        }
                    };
                    overlay.appendChild(crack);
                    Game.crackCount++;
                    
                    // Auto select first if none selected
                    if(document.querySelectorAll('.selected-target').length === 0) {
                        crack.classList.add('selected-target');
                    }
                }
            }, 800);
        }

        // 4. ç‰©è³‡æ¥æ¥æ¨‚
        function startFallingGame() {
            Game.state = 'game_falling'; Game.itemsCaught = 0;
            document.getElementById('falling-game-overlay').style.display = 'block';
            
            // è§¸æ§æ§åˆ¶
            document.getElementById('falling-game-overlay').onpointermove = (e) => {
                const rect = e.target.getBoundingClientRect();
                let x = e.clientX - rect.left - 50; // Center catcher
                Game.catcherX = Math.max(0, Math.min(700, x));
                document.getElementById('catcher-box').style.left = Game.catcherX + 'px';
            };

            Game.fallingSpawnTimer = setInterval(() => {
                const item = document.createElement('div');
                item.className = 'falling-item';
                const type = Math.random();
                item.innerText = type > 0.7 ? 'ğŸª¨' : (type > 0.35 ? 'ğŸ’§' : 'ğŸ–');
                item.dataset.type = type > 0.7 ? 'bad' : 'good';
                item.style.left = Math.random() * 750 + 'px';
                item.style.top = '-50px';
                document.getElementById('falling-game-overlay').appendChild(item);

                let fallInterval = setInterval(() => {
                    let top = parseInt(item.style.top);
                    if(top > 600) { clearInterval(fallInterval); item.remove(); }
                    else {
                        item.style.top = (top + 5) + 'px';
                        // ç¢°æ’åˆ¤å®š
                        if(top > 450 && top < 550) {
                            let itemLeft = parseInt(item.style.left);
                            if(itemLeft > Game.catcherX && itemLeft < Game.catcherX + 100) {
                                clearInterval(fallInterval); item.remove();
                                if(item.dataset.type === 'good') {
                                    AudioSys.playSFX('correct'); Game.itemsCaught++;
                                } else {
                                    AudioSys.playSFX('wrong'); FX.shake();
                                }
                                if(Game.itemsCaught >= 5) {
                                    clearInterval(Game.fallingSpawnTimer);
                                    setTimeout(() => {
                                        document.getElementById('falling-game-overlay').style.display = 'none';
                                        Game.currentScene = 'c6_map_start'; Game.state = 'dialogue'; renderScene();
                                    }, 1000);
                                }
                            }
                        }
                    }
                }, 20);
            }, 1000);
        }

        // 5. é€ƒç”Ÿåæ‡‰
        function startReflexGame() {
            Game.state = 'game_reflex'; Game.reflexScore = 0;
            document.getElementById('reflex-game-overlay').style.display = 'flex';
            nextReflexArrow();
        }
        function nextReflexArrow() {
            if(Game.reflexScore >= 3) {
                setTimeout(() => {
                    document.getElementById('reflex-game-overlay').style.display = 'none';
                    Game.currentScene = 'chance_5_trigger'; Game.state = 'dialogue'; renderScene();
                }, 500);
                return;
            }
            const dirs = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            const symbols = {'ArrowUp':'â¬†ï¸', 'ArrowDown':'â¬‡ï¸', 'ArrowLeft':'â¬…ï¸', 'ArrowRight':'â¡ï¸'};
            const target = dirs[Math.floor(Math.random()*4)];
            Game.reflexTarget = target;
            document.getElementById('reflex-arrow').innerText = symbols[target];
        }
        function checkReflexInput(key) {
            if(key === Game.reflexTarget) {
                AudioSys.playSFX('correct'); Game.reflexScore++; nextReflexArrow();
            } else {
                AudioSys.playSFX('wrong'); FX.shake();
            }
        }

        // 6. ç†è³ å¯©æ ¸
        function startStamperGame() {
            Game.state = 'game_stamper'; Game.docScore = 0;
            document.getElementById('stamper-game-overlay').style.display = 'flex';
            nextDoc();
        }
        function nextDoc() {
            Game.docValid = Math.random() > 0.5;
            document.getElementById('doc-seal').style.display = Game.docValid ? 'block' : 'none';
        }
        function checkDoc(approved) {
            if ((approved && Game.docValid) || (!approved && !Game.docValid)) {
                AudioSys.playSFX('correct'); Game.docScore++;
                if(Game.docScore >= 3) {
                     document.getElementById('stamper-game-overlay').style.display = 'none';
                     Game.currentScene = 'c10_claim_done'; Game.state = 'dialogue'; renderScene();
                } else {
                    nextDoc();
                }
            } else {
                AudioSys.playSFX('wrong'); FX.shake();
            }
        }

        // --- åŸæœ‰å°éŠæˆ²ä¿ç•™ ---
        function startKeypadGame() {
            Game.state = 'game_keypad'; Game.keypadValue = "";
            document.getElementById('keypad-display').innerText = "";
            document.getElementById('keypad-overlay').style.display = 'flex';
        }
        function keypadInput(val) {
            AudioSys.playSFX('type'); const display = document.getElementById('keypad-display');
            if (val === 'C') Game.keypadValue = "";
            else if (val === 'E') {
                if (Game.keypadValue === "1350") {
                    AudioSys.playSFX('correct'); display.style.color = 'lime'; display.innerText = "ACCESS GRANTED";
                    setTimeout(() => {
                        document.getElementById('keypad-overlay').style.display = 'none';
                        Game.currentScene = 'c4_keypad_done'; Game.state = 'dialogue'; renderScene();
                    }, 1000);
                } else {
                    AudioSys.playSFX('wrong'); display.style.color = 'red'; FX.shake();
                    setTimeout(() => { display.style.color = 'var(--neon-green)'; Game.keypadValue = ""; display.innerText = ""; }, 500);
                }
                return;
            } else if (Game.keypadValue.length < 4) Game.keypadValue += val;
            display.innerText = Game.keypadValue;
        }

        let balanceInterval;
        function startBalanceGame() {
            Game.state = 'game_balance'; Game.balancePos = 50; Game.balanceVel = 0;
            document.getElementById('balance-overlay').style.display = 'flex';
            const overlay = document.getElementById('balance-overlay');
            
            // Pointer support
            overlay.onpointerdown = (e) => {
                const rect = overlay.getBoundingClientRect();
                // Click left side to push left (balanceVel decreases), right side pushes right
                if ((e.clientX - rect.left) < rect.width / 2) Game.balanceVel -= 2; else Game.balanceVel += 2;
            };

            let duration = 300;
            balanceInterval = setInterval(() => {
                Game.balanceVel += (Math.random() - 0.5) * 1.5; Game.balancePos += Game.balanceVel; Game.balanceVel *= 0.95;
                if (Game.balancePos < 0) Game.balancePos = 0; if (Game.balancePos > 100) Game.balancePos = 100;
                document.getElementById('balance-marker').style.left = Game.balancePos + '%';
                if (Game.balancePos < 10 || Game.balancePos > 90) document.getElementById('balance-marker').style.background = 'red';
                else document.getElementById('balance-marker').style.background = 'white';
                duration--;
                if (duration <= 0) {
                    clearInterval(balanceInterval); overlay.onpointerdown = null;
                    document.getElementById('balance-overlay').style.display = 'none';
                    Game.currentScene = 'c7_quake'; Game.state = 'dialogue'; renderScene();
                }
            }, 16);
        }

        function startDebrisGame() {
            Game.state = 'game_debris'; Game.debrisHealth = 5;
            document.getElementById('debris-overlay').style.display = 'flex';
            document.getElementById('debris-cover').style.opacity = 1;
        }
        function hitDebris() {
            if (Game.state !== 'game_debris') return;
            Game.debrisHealth--; AudioSys.playSFX('damage'); FX.shake();
            document.getElementById('debris-cover').style.opacity = Game.debrisHealth / 5;
            if (Game.debrisHealth <= 0) {
                AudioSys.playSFX('win');
                setTimeout(() => {
                    document.getElementById('debris-overlay').style.display = 'none';
                    Game.currentScene = 'c8_ruin'; Game.state = 'dialogue'; renderScene();
                }, 1000);
            }
        }

        /* === å…¶ä»–å…¬ç”¨å‡½æ•¸ === */
        function showRiskMatrix() { Game.state = 'matrix'; document.getElementById('risk-matrix-overlay').style.display = 'flex'; }
        function closeRiskMatrix() { AudioSys.playSFX('select'); document.getElementById('risk-matrix-overlay').style.display = 'none'; Game.state = 'dialogue'; Game.currentScene = 'c2_risk'; renderScene(); }
        function showLearningCard(l) { Game.state = 'learning'; document.getElementById('learn-title').innerText = l.title; document.getElementById('learn-content').innerText = l.content; document.getElementById('learning-overlay').style.display = 'flex'; }
        function closeLearning() { document.getElementById('learning-overlay').style.display = 'none'; AudioSys.playSFX('select'); finishTyping(); }
        
        function startMapGame() {
            Game.state = 'map'; Game.mapCursorIndex = 4;
            document.getElementById('map-grid').innerHTML = '';
            document.getElementById('map-interface').style.display = 'flex';
            const tilesData = [
                { type: 'home', icon: 'ğŸ ' }, { type: 'store', icon: 'ğŸª' }, { type: 'school', icon: 'ğŸ«' },
                { type: 'store', icon: 'ğŸª' }, { type: 'park', icon: 'ğŸŒ³' }, { type: 'store', icon: 'ğŸª' },
                { type: 'school', icon: 'ğŸ«' }, { type: 'store', icon: 'ğŸª' }, { type: 'store', icon: 'ğŸª' }
            ];
            tilesData.forEach((data, i) => {
                const tile = document.createElement('div'); tile.className = 'map-tile'; tile.dataset.type = data.type; tile.innerText = data.icon;
                if(data.type === 'home') tile.style.background = '#ffff00';
                tile.onclick = () => checkMapSelection(data.type);
                tile.onmouseenter = () => { Game.mapCursorIndex = i; updateMapCursor(); };
                document.getElementById('map-grid').appendChild(tile);
            });
            updateMapCursor();
        }
        function updateMapCursor() { document.querySelectorAll('.map-tile').forEach((tile, i) => { if(i === Game.mapCursorIndex) tile.classList.add('selected'); else tile.classList.remove('selected'); }); }
        function checkMapSelection(type) {
            if (type === 'park' || type === 'school') { AudioSys.playSFX('correct'); document.getElementById('map-interface').style.display = 'none'; Game.state = 'dialogue'; Game.currentScene = 'c6_map_done'; renderScene(); }
            else if (type === 'home') { AudioSys.playSFX('wrong'); alert("åœ°éœ‡æ™‚å¾…åœ¨å®¶è£¡å¯èƒ½æœƒæœ‰å±éšªï¼"); }
            else { AudioSys.playSFX('wrong'); FX.shake(); }
        }

        function startMemoryGame() {
            Game.state = 'memory'; document.getElementById('memory-game-overlay').style.display = 'flex';
            const grid = document.getElementById('memory-grid'); grid.innerHTML = ''; Game.flippedCards = []; Game.matchedCount = 0; Game.memoryCursorIndex = 0;
            const pairs = [ { id: 1, text: 'è¦é¿', icon: 'ğŸ›¡ï¸' }, { id: 1, text: 'é€ƒè·‘', icon: 'ğŸƒ' }, { id: 2, text: 'é™ä½', icon: 'ğŸ”§' }, { id: 2, text: 'æ»…ç«å™¨', icon: 'ğŸ§¯' }, { id: 3, text: 'è‡ªç•™', icon: 'ğŸ’°' }, { id: 3, text: 'å°éŒ¢', icon: 'ğŸ’µ' }, { id: 4, text: 'è½‰ç§»', icon: 'âš–ï¸' }, { id: 4, text: 'ä¿éšª', icon: 'ğŸ“' } ];
            pairs.sort(() => Math.random() - 0.5);
            pairs.forEach((data, i) => {
                const card = document.createElement('div'); card.className = 'memory-card'; card.dataset.id = data.id;
                const content = document.createElement('div'); content.className = 'memory-text'; content.innerHTML = `${data.icon}<br>${data.text}`;
                card.appendChild(content);
                card.onclick = () => flipMemoryCard(card);
                // Mouse hover also updates cursor
                card.onmouseenter = () => {
                    Game.memoryCursorIndex = i;
                    document.querySelectorAll('.memory-card').forEach(c => c.classList.remove('selected-target'));
                    card.classList.add('selected-target');
                }
                grid.appendChild(card);
            });
            // Init keyboard selection
            document.querySelectorAll('.memory-card')[0].classList.add('selected-target');
        }
        function flipMemoryCard(card) {
            if (card.classList.contains('flipped') || card.classList.contains('matched') || Game.flippedCards.length >= 2) return;
            AudioSys.playSFX('card_flip'); card.classList.add('flipped'); Game.flippedCards.push(card);
            if (Game.flippedCards.length === 2) setTimeout(checkMemoryMatch, 800);
        }
        function checkMemoryMatch() {
            const [c1, c2] = Game.flippedCards;
            if (c1.dataset.id === c2.dataset.id) { AudioSys.playSFX('correct'); c1.classList.add('matched'); c2.classList.add('matched'); Game.matchedCount++; if (Game.matchedCount === 4) setTimeout(() => { document.getElementById('memory-game-overlay').style.display = 'none'; AudioSys.playSFX('win'); Game.state = 'dialogue'; Game.currentScene = 'c3_memory_done'; renderScene(); }, 1000); }
            else { AudioSys.playSFX('wrong'); c1.classList.remove('flipped'); c2.classList.remove('flipped'); }
            Game.flippedCards = [];
        }

        const ChanceEvents = [ { type: 'good', text: 'ğŸ‰ ä¸­æ¨‚é€ï¼\nè³‡ç”¢ +$50,000', money: 50000, hp: 0 }, { type: 'bad', text: 'ğŸ¤’ è…¸èƒƒç‚\nHP -20', money: -5000, hp: -20 }, { type: 'good', text: 'ğŸ“ˆ è‚¡ç¥¨å¤§æ¼²\nè³‡ç”¢ +$30,000', money: 30000, hp: 0 } ];
        function triggerChanceGame(returnScene) { Game.returnScene = returnScene; Game.state = 'card'; Game.cardCursorIndex = 0; document.getElementById('chance-game-overlay').style.display = 'flex'; document.querySelectorAll('.game-card').forEach(c => { c.classList.remove('flipped', 'selected'); c.innerText = ''; c.style.background = ""; }); updateCardCursor(); }
        function updateCardCursor() { document.querySelectorAll('.game-card').forEach((c, i) => { if(i === Game.cardCursorIndex) c.classList.add('selected'); else c.classList.remove('selected'); }); }
        function selectCard(index) {
            if (document.querySelectorAll('.game-card.flipped').length > 0) return;
            AudioSys.playSFX('card_flip'); const card = document.getElementById(`card-${index}`); card.classList.add('flipped');
            const event = ChanceEvents[Math.floor(Math.random() * ChanceEvents.length)];
            card.innerText = event.text; card.style.background = event.type === 'good' ? "gold" : "#ffaaaa";
            if (event.type === 'bad') FX.shake();
            Game.money += event.money; Game.hp += event.hp; updateUI();
            setTimeout(() => { document.getElementById('chance-game-overlay').style.display = 'none'; Game.state = 'dialogue'; Game.currentScene = Game.returnScene; renderScene(); }, 2500);
        }
        function triggerCongrats() { AudioSys.playSFX('win'); document.getElementById('congrats-overlay').style.display = 'flex'; setTimeout(() => { document.getElementById('congrats-overlay').style.display = 'none'; }, 5000); }

        function resizeGame() { const wrapper = document.getElementById('game-wrapper'); const scale = Math.min(window.innerWidth / 800, (window.innerHeight - 30) / 600); wrapper.style.transform = `scale(${scale * 0.95})`; }
        window.addEventListener('resize', resizeGame); window.onload = resizeGame;
    </script>
</body>
</html>